---
import RecipeCard from "./RecipeCard.astro";
import { getCollection } from "astro:content";
const { category } = Astro.props;

const recipeEntries = await getCollection("recipes", ({ id }) =>
  id.startsWith(category),
);

// sort recipeEntries by alphabetical order
const sortedEntries = recipeEntries.sort((a, b) => {
  const titleA = a.data.title.toUpperCase();
  const titleB = b.data.title.toUpperCase();
  if (titleA < titleB) {
    return -1;
  }
  if (titleA > titleB) {
    return 1;
  }
  return 0;
});

// capitalize first letter
const categoryTitle = category.charAt(0).toUpperCase() + category.slice(1);
---

<div class="category-wrapper" data-view="grid">
  <h2>{categoryTitle}</h2>
  <ul role="list">
    {
      sortedEntries.map((recipe) => (
        <li>
          <RecipeCard {recipe} />
        </li>
      ))
    }
  </ul>
</div>

<style>
  @layer components {
    .category-wrapper {
      display: grid;
      /* gap: var(--space-sm); */
      padding-block: var(--space-xl);
      content-visibility: auto;
      contain-intrinsic-size: 700px;

      container: category / inline-size;
    }

    .category-wrapper + .category-wrapper {
      border-top: 1px dashed color-mix(in oklab, var(--gray-300), #fff 40%);
    }

    ul {
      display: grid;
      grid-template-columns: repeat(
        auto-fill,
        minmax(min(100%, 110px + 15cqw), 1fr)
      );
      gap: var(--space-md);
    }

    h2 {
      padding-block-end: var(--space-sm);
      /* margin-bottom: var(--space-md); */
      /* border-bottom: 1px solid var(--gray-300); */
      max-width: none;
      display: flex;
      align-items: center;
      gap: var(--space-sm);
      scroll-margin-block-start: var(--space-xl);
    }

    h2::after {
      content: "";
      height: 1px;
      flex: 1;
      background: linear-gradient(
        to right,
        color-mix(in oklab, var(--color-primary), #fff 40%),
        #0000
      );
    }

    /* List view */
    .category-wrapper[data-view="list"] {
      padding-block: var(--space-md);
    }

    [data-view="list"] ul {
      grid: revert;
      /* list-style: revert;
      padding-inline-start: 1em; */
    }

    [data-view="list"] :global(figure) {
      display: none;
    }

    [data-view="list"] :global(article) {
      /* background: none;
      box-shadow: none;*/
      padding: var(--space-sm) var(--space-md);
      border-inline-start: 3px solid color-mix(in oklab, var(--color-primary), #fff 50%);
    }
    [data-view="list"] :global(p) {
      grid-area: unset;
    }
  }
</style>

<script>
  // Guard against multiple listener attachments.
  if (!document.documentElement.dataset.toggleListenersInit) {
    document.documentElement.dataset.toggleListenersInit = "1";

    document.querySelectorAll(".toggle-view").forEach((toggleBtn) => {
      toggleBtn.addEventListener("click", () => {
        const isPressed = toggleBtn.getAttribute("aria-pressed") === "true";
        toggleBtn.setAttribute("aria-pressed", (!isPressed).toString());

        document.querySelectorAll(".category-wrapper").forEach((list) => {
          const el = list as HTMLElement;
          el.dataset.view = el.dataset.view === "grid" ? "list" : "grid";
        });
      });
    });
  }
</script>
