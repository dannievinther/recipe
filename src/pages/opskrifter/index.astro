---
import { getCollection } from "astro:content";
import LayoutListIcon from "../../icons/layout-list.svg";
import CategoryList from "../../components/CategoryList.astro";
import IndexLayout from "../../layouts/IndexLayout.astro";
import Layout from "../../layouts/Layout.astro";

const recipeEntries = await getCollection("recipes");
const collator = new Intl.Collator("da", { sensitivity: "base" });

// Extract unique categories from recipe ids (e.g., "frokost/bananpandekager")
const categories = recipeEntries.map((recipe) => recipe.id.split("/")[0]);
const uniqueCategories = [...new Set(categories)] as string[];

// Sort categories in desired order
const sortOrder = ["morgenmad", "frokost", "aftensmad", "snacks"];
uniqueCategories.sort((a, b) => sortOrder.indexOf(a) - sortOrder.indexOf(b));

const groupedByCategory = uniqueCategories.map((category) => {
  const recipes = recipeEntries
    .filter((recipe) => recipe.id.startsWith(`${category}/`))
    .sort((a, b) => collator.compare(a.data.title, b.data.title));

  return { category, recipes };
});
---

<Layout title="Opskrifter">
  <IndexLayout>
    <h1 class="visually-hidden">Opskrifter</h1>
    <div class="toggle-wrapper">
      <button class="toggle-view" aria-pressed="false" type="button">
        <LayoutListIcon class="icon" aria-hidden="true" />
      </button>
    </div>
    {
      groupedByCategory.map(({ category, recipes }) => (
        <CategoryList category={category} recipes={recipes} />
      ))
    }
  </IndexLayout>
</Layout>

<style>
  @layer components {
    .toggle-wrapper {
      position: sticky;
      top: 1rem;
      place-self: center end;
      z-index: 10;
    }

    .toggle-view {
      appearance: none;
      background: #fff;
      border: 1px solid var(--gray-300);
      box-shadow: none;
      padding: var(--space-sm);
      border-radius: var(--border-radius-medium);
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
      transition: background-color 0.18s ease, border-color 0.18s ease,
        transform 0.18s ease;
    }

    .toggle-view[aria-pressed="true"] {
      background: var(--gray-200);
      border-color: var(--gray-400);
    }

    .toggle-view:active {
      transform: translateY(1px) scale(0.99);
    }

    .toggle-view .icon {
      width: var(--space-lg);
      height: var(--space-lg);
    }

  }
</style>

<script>
  const toggleButton = document.querySelector(".toggle-view");
  const categoryLists = document.querySelectorAll(".category-wrapper");

  toggleButton?.addEventListener("click", () => {
    const isListMode = toggleButton.getAttribute("aria-pressed") === "true";
    const nextView = isListMode ? "grid" : "list";

    toggleButton.setAttribute("aria-pressed", String(!isListMode));
    categoryLists.forEach((categoryList) => {
      categoryList.dataset.view = nextView;
    });
  });
</script>
