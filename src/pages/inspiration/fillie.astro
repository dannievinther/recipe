---
import RecipeCard from "../../components/RecipeCard.astro";
import Layout from "../../layouts/Layout.astro";
import { getCollection } from "astro:content";
import { getImage } from "astro:assets";

const recipeEntries = await getCollection("recipes");
const sortOrder = ["morgenmad", "frokost", "aftensmad", "snacks"];
const categories = [...new Set(recipeEntries.map((recipe) => recipe.id.split("/")[0]))];
const sortedCategories = categories.sort((a, b) => {
  const ai = sortOrder.indexOf(a);
  const bi = sortOrder.indexOf(b);
  const rankA = ai === -1 ? 999 : ai;
  const rankB = bi === -1 ? 999 : bi;
  return rankA - rankB;
});

const inspirationItems = await Promise.all(
  recipeEntries.map(async (recipe) => {
    const image = recipe.data.img;
    const optimizedImage = image
      ? await getImage({
          src: image,
          width: 400,
          format: "avif",
          fit: "cover",
        })
      : null;
    return {
      category: recipe.id.split("/")[0],
      title: recipe.data.title,
      href: `/opskrifter/${recipe.id.replace(/\.(md|mdx)$/i, "")}/`,
      time: recipe.data.time ? String(recipe.data.time) : "",
      imgSrc: optimizedImage?.src ?? image?.src ?? "",
      imgWidth: Number(optimizedImage?.attributes?.width ?? image?.width ?? 400),
      imgHeight: Number(optimizedImage?.attributes?.height ?? image?.height ?? 266),
    };
  }),
);

const hasRecipes = inspirationItems.length > 0;
const initialRecipe = hasRecipes ? recipeEntries[0] : null;
---

<Layout title="Opskrifter">
  <main class="inspiration-main">
    <section class="inspiration-hero">
      <h1>Inspiration</h1>
      <p>Et hurtigt swipe gennem idéer til næste måltid.</p>
    </section>

    <section class="inspiration-filters" aria-label="Filtrer inspiration">
      <button class="filter-btn" type="button" data-filter="all" aria-pressed="true">
        Alle
      </button>
      {
        sortedCategories.map((category) => (
          <button class="filter-btn" type="button" data-filter={category}>
            {category.charAt(0).toUpperCase() + category.slice(1)}
          </button>
        ))
      }
    </section>

    <section class="inspiration-layout">
      <div class="inspiration-wrapper">
        {
          !hasRecipes ? (
            <p>Der er ingen opskrifter endnu. Kom tilbage senere.</p>
          ) : (
            <RecipeCard recipe={initialRecipe} class="inspiration-item" isEllipsis={true} />
          )
        }
      </div>
      <script
        id="inspirationData"
        type="application/json"
        set:html={JSON.stringify(inspirationItems)}></script>

      <aside class="inspiration-panel">
        <p class="items-left"><span class="number">0</span> forslag tilbage</p>
        <a id="openRecipe" class="open-recipe" href="/opskrifter/" data-astro-prefetch>
          Åbn opskrift
        </a>
        <div class="inspiration-controls">
          <button id="prev" type="button">Forrige</button>
          <button id="next" type="button">Næste</button>
          <button id="shuffle" type="button">Mix</button>
        </div>
        <button id="saveFavorite" class="save-favorite" type="button">
          Gem som favorit
        </button>
      </aside>
    </section>

    <section class="favorites" hidden>
      <h2>Gemte favoritter</h2>
      <ul id="favoritesList" role="list"></ul>
    </section>
  </main>
</Layout>

<style>
  @layer components {
    .inspiration-main {
      min-height: calc(100vh - 90px);
      min-height: calc(100dvh - 90px);
      display: grid;
      grid: auto-flow min-content / 1fr minmax(0, 68ch) 1fr;
      column-gap: var(--space-md);
      align-content: center;
      gap: var(--space-md);
      padding-block: var(--space-md);
    }

    .inspiration-main > * {
      grid-column: 2;
    }

    .inspiration-hero {
      display: grid;
      gap: var(--space-xxs);
    }

    .inspiration-hero p {
      color: var(--gray-700);
      margin: 0;
    }

    .inspiration-filters {
      display: flex;
      gap: var(--space-xs);
      overflow-x: auto;
      padding-block-end: var(--space-xxs);
    }

    .inspiration-layout {
      display: grid;
      gap: var(--space-md);
      align-items: start;
    }

    @media (width >= 52rem) {
      .inspiration-layout {
        grid-template-columns: minmax(0, 1fr) minmax(14rem, 17rem);
      }
    }

    .inspiration-wrapper {
      min-block-size: 22rem;
    }

    .inspiration-panel {
      display: grid;
      gap: var(--space-sm);
      align-content: start;
      padding: var(--space-md);
      background: #fff;
      border-radius: var(--border-radius-lg);
      border: 1px solid var(--gray-300);
    }

    .items-left {
      margin: 0;
      color: var(--gray-700);
      font-size: var(--size-step--1);
      font-weight: 600;
    }

    .number {
      color: var(--text-body);
    }

    .open-recipe {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-height: 2.6rem;
      padding-inline: var(--space-md);
      border-radius: var(--border-radius-medium);
      color: #fff;
      background: var(--text-body);
      text-decoration: none;
      font-weight: 600;
    }

    .inspiration-controls {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: var(--space-xs);
    }

    .favorites {
      margin-block-end: 7rem;
      padding: var(--space-md);
      background: #fff;
      border-radius: var(--border-radius-lg);
      border: 1px solid var(--gray-300);
      display: grid;
      gap: var(--space-sm);
    }

    .favorites h2 {
      margin: 0;
      font-size: var(--size-step-1);
    }

    .favorites ul {
      display: grid;
      gap: var(--space-xs);
    }

    .favorites li {
      display: flex;
      align-items: center;
      gap: var(--space-xs);
    }

    .favorites a {
      flex: 1;
      text-decoration: none;
      color: var(--text-body);
      font-weight: 600;
      line-height: 1.3;
    }

    :global(.inspiration-item[hidden]) {
      display: none !important;
    }

    button,
    .filter-btn {
      appearance: none;
      border: 1px solid var(--gray-300);
      background: #fff;
      border-radius: var(--border-radius-medium);
      color: var(--gray-700);
      min-height: 2.4rem;
      padding: 0.45rem 0.75rem;
      font-family:
        Mona Sans,
        system-ui;
      font-size: 0.92rem;
      font-weight: 560;
      cursor: pointer;
      user-select: none;
      touch-action: manipulation;
    }

    .filter-btn[aria-pressed="true"] {
      color: #fff;
      background: var(--text-body);
      border-color: var(--text-body);
    }

    .save-favorite[disabled] {
      opacity: 0.6;
      cursor: default;
    }
  }
</style>

<script>
  const FAVORITES_KEY = "fogop:inspirationFavorites";
  const dataElement = document.getElementById("inspirationData");
  const items = dataElement ? JSON.parse(dataElement.textContent || "[]") : [];
  const wrapper = document.querySelector(".inspiration-wrapper");
  const itemCard = wrapper?.querySelector(".inspiration-item");
  const itemLink = itemCard?.querySelector("a");
  const itemImage = itemCard?.querySelector("img");
  const itemCaption = itemCard?.querySelector("figcaption");
  const itemTime = itemCaption?.querySelector("span");

  const nextButton = document.getElementById("next");
  const prevButton = document.getElementById("prev");
  const shuffleButton = document.getElementById("shuffle");
  const saveFavoriteButton = document.getElementById("saveFavorite");
  const itemsLeft = document.querySelector(".items-left .number");
  const openRecipe = document.getElementById("openRecipe");
  const filterButtons = [...document.querySelectorAll(".filter-btn")];
  const favoritesSection = document.querySelector(".favorites");
  const favoritesList = document.getElementById("favoritesList");

  const state = {
    filter: "all",
    visible: [],
    index: 0,
  };

  function shuffle(array) {
    const copy = [...array];
    for (let i = copy.length - 1; i > 0; i -= 1) {
      const j = Math.floor(Math.random() * (i + 1));
      [copy[i], copy[j]] = [copy[j], copy[i]];
    }
    return copy;
  }

  function getCurrentItem() {
    return state.visible[state.index] || null;
  }

  function formatTime(value) {
    const normalized = String(value || "").trim();
    if (!normalized) return "";
    if (/\bmin(?:\.|utter)?\b/i.test(normalized)) return normalized;
    return `${normalized} min.`;
  }

  function readFavorites() {
    try {
      const parsed = JSON.parse(localStorage.getItem(FAVORITES_KEY) || "[]");
      return Array.isArray(parsed) ? parsed : [];
    } catch {
      return [];
    }
  }

  function writeFavorites(favorites) {
    localStorage.setItem(FAVORITES_KEY, JSON.stringify(favorites));
  }

  function renderFavorites() {
    if (!favoritesList || !favoritesSection) return;

    const favorites = readFavorites();
    favoritesList.textContent = "";

    if (favorites.length === 0) {
      favoritesSection.hidden = true;
      return;
    }

    favoritesSection.hidden = false;
    const fragment = document.createDocumentFragment();

    favorites.forEach((favorite) => {
      const li = document.createElement("li");
      const link = document.createElement("a");
      link.href = favorite.href;
      link.textContent = favorite.title;
      link.dataset.astroPrefetch = "";

      const remove = document.createElement("button");
      remove.type = "button";
      remove.dataset.removeHref = favorite.href;
      remove.textContent = "Fjern";

      li.append(link, remove);
      fragment.append(li);
    });

    favoritesList.append(fragment);
  }

  function syncFilterButtons() {
    filterButtons.forEach((button) => {
      const isActive = button.dataset.filter === state.filter;
      button.setAttribute("aria-pressed", String(isActive));
    });
  }

  function refreshVisible({ reshuffle = true } = {}) {
    const filtered = items.filter((item) => {
      if (state.filter === "all") return true;
      return item.category === state.filter;
    });

    state.visible = reshuffle ? shuffle(filtered) : filtered;
    state.index = 0;
  }

  function renderCurrent() {
    const current = getCurrentItem();

    if (!current) {
      if (itemsLeft) itemsLeft.textContent = "0";
      if (openRecipe) openRecipe.setAttribute("href", "/opskrifter/");
      if (saveFavoriteButton) saveFavoriteButton.setAttribute("disabled", "true");
      itemCard?.setAttribute("hidden", "");
      return;
    }

    itemCard?.removeAttribute("hidden");
    if (itemLink) {
      itemLink.href = current.href;
      itemLink.textContent = current.title;
    }

    if (itemImage) {
      itemImage.src = current.imgSrc;
      itemImage.width = current.imgWidth;
      itemImage.height = current.imgHeight;
      itemImage.loading = "eager";
      itemImage.decoding = "async";
    }

    if (itemCaption && itemTime) {
      const label = formatTime(current.time);
      itemCaption.hidden = !label;
      itemTime.textContent = label;
    }

    if (itemsLeft) {
      itemsLeft.textContent = `${Math.max(state.visible.length - state.index - 1, 0)}`;
    }

    if (openRecipe) {
      openRecipe.setAttribute("href", current.href || "/opskrifter/");
    }

    if (saveFavoriteButton) {
      saveFavoriteButton.removeAttribute("disabled");
    }
  }

  function next() {
    if (state.visible.length === 0) return;
    state.index = (state.index + 1) % state.visible.length;

    if (state.index === 0) {
      state.visible = shuffle(state.visible);
    }

    renderCurrent();
  }

  function prev() {
    if (state.visible.length === 0) return;
    state.index = state.index === 0 ? state.visible.length - 1 : state.index - 1;
    renderCurrent();
  }

  function setFilter(filterValue) {
    state.filter = filterValue;
    refreshVisible();
    syncFilterButtons();
    renderCurrent();
  }

  filterButtons.forEach((button) => {
    button.addEventListener("click", () => {
      const filterValue = button.dataset.filter || "all";
      setFilter(filterValue);
    });
  });

  nextButton?.addEventListener("click", next);
  prevButton?.addEventListener("click", prev);
  shuffleButton?.addEventListener("click", () => {
    state.visible = shuffle(state.visible);
    state.index = 0;
    renderCurrent();
  });

  saveFavoriteButton?.addEventListener("click", () => {
    const current = getCurrentItem();
    if (!current) return;

    const href = current.href;
    const title = current.title;
    const category = current.category;

    if (!href || !title) return;

    const favorites = readFavorites();
    const deduped = favorites.filter((favorite) => favorite.href !== href);

    deduped.unshift({
      href,
      title,
      category: category || "",
      updatedAt: Date.now(),
    });

    writeFavorites(deduped.slice(0, 12));
    renderFavorites();
  });

  favoritesList?.addEventListener("click", (event) => {
    const target = event.target;
    if (!(target instanceof HTMLButtonElement)) return;

    const href = target.dataset.removeHref;
    if (!href) return;

    const favorites = readFavorites().filter((favorite) => favorite.href !== href);
    writeFavorites(favorites);
    renderFavorites();
  });

  refreshVisible();
  syncFilterButtons();
  renderCurrent();
  renderFavorites();
</script>
